#!/bin/rc

rfork

rroot=/mnt/richterm

history=`{pwd}
forward=()

fn clear {
	echo clear > $rroot/ctl
}

fn _exit {
	clear
	echo -n > $rroot/menu
	exit
}

fn ldir {
	cd $1
	history = (`{pwd} $history)
	forward = ()
	clear
	Dir
}

fn lmarkdown {
	fname=`{basename $1}
	cd `{basename -d $1}
	history = (`{pwd}^/$fname $history)
	forward = ()
	clear
	Markdown $fname
}

fn menu {
	switch ($1) {
	case 'Back';
		if (test $#history '!=' 1) {
			newforward = ($history(1) $forward)
			link = $history(2)
			history = $history(3-)
			link $link
			forward = $newforward
		}
	case 'Exit'; _exit
	}
}

fn link {
	switch($1) {
	case http://*; plumb $1
	case *.md; lmarkdown $1
	case *.html
		md=`{echo $1|sed 's/\.html/\.md/'}
		if (test -r $md)  lmarkdown $md
		if not echo 'can''t open file' $1
	case *
		if (test -d $1) ldir $1
		if not plumb $1
	}
}

bind -a bin/$cputype /bin

cat > $rroot/menu <<EOF
----
Back
Exit
EOF

clear
Dir

event=''

while ( { event=`{read $rroot/ctl} } ) {
	if (test -z $"event) _exit
	type=$event(1)
	action=$event(2)
	switch($type) {
	case 'menu'; menu $action
	case 'link'; link $action
	}
}
